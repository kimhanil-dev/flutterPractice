# í•˜ë‚˜ì˜ workflowë¥¼ ì •ì˜í•˜ëŠ” íŒŒì¼ìž…ë‹ˆë‹¤.
# í•´ë‹¹ workflowì˜ ì´ë¦„
name: Flutter_GitHub_Actions
# Eventë¥¼ ì •ì˜í•˜ëŠ” ê³³ìž…ë‹ˆë‹¤.
on:
  # ì´ë²ˆ ì‹¤ìŠµì—ì„œëŠ” main ë¸Œëžœì¹˜ì— pushì»¤ë§¨ë“œë¥¼
  # ìˆ˜í–‰í•˜ì˜€ì„ ê²½ìš° workflowê°€ ì‹¤í–‰ë˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.
  push:
    branches: [ main ]
# jobë“¤ì„ ì •ì˜í•˜ëŠ” ì˜ì—­ìž…ë‹ˆë‹¤.
jobs:
  # í•˜ë‚˜ì˜ jobì„ "build"ë¼ê³  í•©ë‹ˆë‹¤.
  # ì´ë²ˆ ì‹¤ìŠµì—ì„œëŠ” í•˜ë‚˜ì˜ job ë§Œì„ ì‚¬ìš©í• 
  # ê²ƒì´ê¸° ë•Œë¬¸ì— í•˜ë‚˜ì˜ buildë§Œ ì •ì˜ë  ê²ƒìž…ë‹ˆë‹¤.
  build:
    name: Running Test and CI / CD
    # í•´ë‹¹ ìž‘ì—…ì´ ì‹¤í–‰ ë  ì¸ìŠ¤í„´ìŠ¤ í™˜ê²½ìž…ë‹ˆë‹¤.
    # ì´ë²ˆ ì‹¤ìŠµì—ì„œëŠ” ubuntu ë¥¼ ì‚¬ìš©í•  ê²ƒìž…ë‹ˆë‹¤.
    runs-on: ubuntu-latest
    # jobì˜ êµ¬ì„±ìš”ì†Œì¸ stepë“¤ì„ ì •ì˜í•œ ê³µê°„ìž…ë‹ˆë‹¤.
    steps:
      # í•˜ë‚˜ì˜ stepì€ name ê³¼ uses(í˜¹ì€ run)ìœ¼ë¡œ êµ¬ì„±
      # nameì€ stepì˜ ì´ë¦„ì´ ì •ì˜ë˜ì–´ ìžˆê³ 
      # uses ëŠ” ë¯¸ë¦¬ ë§Œë“¤ì–´ì§„ actionì„ ì´ìš©í•˜ëŠ” ê²ƒì´ê³ 
      # run ì€ ì§ì ‘ ì¸ìŠ¤í„´ìŠ¤ì— ì»¤ë§¨ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ê²ƒìž…ë‹ˆë‹¤.
      # ì²«ë²ˆì§¸ ìŠ¤í…ì€ actionìž…ë‹ˆë‹¤
      # Github repositoryì˜ ì†ŒìŠ¤ë¥¼ ê°€ì ¸ì˜¤ëŠ” actionìž…ë‹ˆë‹¤.
      - name: Checkout source code
        uses: actions/checkout@v4
      
      # ë‘ë²ˆì§¸ stepì€ ì¸ìŠ¤í„´ìŠ¤ì— Flutter SDKë¥¼ ì„¤ì¹˜í•˜ëŠ” action ìž…ë‹ˆë‹¤.
      # with ì»¤ë§¨ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ SDKì˜ ìƒì„¸ ë²„ì „ì„ ì„¤ì •í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
      - name: Install Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.3.2'
      
      # ì„¸ë²ˆì§¸ stepì€ í•´ë‹¹ ë ˆí¬ì§€í† ë¦¬ê°€ ì‚¬ìš©í•˜ëŠ” íŒ¨í‚¤ì§€ë¥¼
      #  importí•˜ëŠ” ë‹¨ê³„ìž…ë‹ˆë‹¤. ì§ì ‘ ì¸ìŠ¤í„´ìŠ¤ì— ì»¤ë§¨ë“œë¥¼ ìž…ë ¥í•©ë‹ˆë‹¤.
      - name: Import Flutter Package
        run: |
          flutter pub get
      # ë„¤ë²ˆì§¸ stepì€ ìž‘ì„±ëœ ì½”ë“œë¥¼ testí•˜ëŠ” ë‹¨ê³„ìž…ë‹ˆë‹¤.
      
      # ë‹¤ì„¯ë²ˆì§¸ stepì€ ìž‘ì„±ëœ ì½”ë“œë¥¼ build í•˜ëŠ” ë‹¨ê³„ìž…ë‹ˆë‹¤.
      # ë¹Œë“œ í›„ ë¹Œë“œ ëœ íŒŒì¼ì„ í”„ë¡œì íŠ¸ ë£¨íŠ¸ë¡œ ì˜®ê¸°ê² ìŠµë‹ˆë‹¤.
      # ì˜®ê¸°ëŠ” ì´ìœ  : .gitignoreì— build í´ë”ê°€ ì •ì˜ë˜ì–´ ìžˆì–´
      # ì¶”í›„ ì‚¬ìš© ë¶ˆê°€. ë”°ë¡œ ì»¤ë°‹ì„ í•˜ì§€ ì•ŠëŠ” ì´ìƒ 
      # ì—¬ê¸°ì„œ ë³€ê²½ëœ ì‚¬í•­ì€ í”„ë¡œì íŠ¸ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.
      # ì´ë¯¸ webì´ë¼ëŠ” í´ë”ê°€ ì¡´ìž¬í•˜ì—¬ web_deployìœ¼ë¡œ ì´ë¦„ì„ ë³€ê²½í•©ë‹ˆë‹¤.
      - name: Build Flutter web
        run: |
          flutter build linux --release --target=lib/server/main.dart
          mv ./build/server .

      - name: create api key file
        run: |
          touch "${{ secrets.API_KEY_PATH }}"
          echo "${{ secrets.GOOGLE_API_KEY }}" >> "${{ secrets.API_KEY_PATH }}"
          touch "${{ secrets.ENV_PATH }}"
          echo "${{ secrets.GSHEET_API_KEY }}" >> "${{ secrets.ENV_PATH }}"
      
      - name: ðŸ“¦ Zip project files
        run: zip -r ./$GITHUB_SHA.zip

      - name: ðŸŒŽ Access to AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_ACCESS_KEY }}
          aws-region: ap-northeast-2a  .

      - name: ðŸš› Upload to S3
        run: aws s3 cp --region ap-northeast-2a ./$GITHUB_SHA.zip s3://${{ secrets.S3_BUCKET_NAME }}/${{ env.S3_BUCKET_DIR_NAME }}/$GITHUB_SHA.zip

      - name: ðŸš€ Deploy to EC2 with CodeDeploy
        run: aws deploy create-deployment
                --application-name hero
                --deployment-config-name CodeDeployDefault.AllAtOnce
                --deployment-group-name deploy-user
                --s3-location bucket=${{ secrets.S3_BUCKET_NAME }},bundleType=zip,key=${{ env.S3_BUCKET_DIR_NAME }}/$GITHUB_SHA.zip
