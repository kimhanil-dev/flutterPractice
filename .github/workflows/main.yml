# 하나의 workflow를 정의하는 파일입니다.
# 해당 workflow의 이름
name: Flutter_GitHub_Actions
# Event를 정의하는 곳입니다.
on:
  # 이번 실습에서는 main 브랜치에 push커맨드를
  # 수행하였을 경우 workflow가 실행되도록 하겠습니다.
  push:
    branches: [ main ]
# job들을 정의하는 영역입니다.
jobs:
  # 하나의 job을 "build"라고 합니다.
  # 이번 실습에서는 하나의 job 만을 사용할
  # 것이기 때문에 하나의 build만 정의될 것입니다.
  build:
    name: Running Test and CI / CD
    # 해당 작업이 실행 될 인스턴스 환경입니다.
    # 이번 실습에서는 ubuntu 를 사용할 것입니다.
    runs-on: ubuntu-latest
    # job의 구성요소인 step들을 정의한 공간입니다.
    steps:
      # 하나의 step은 name 과 uses(혹은 run)으로 구성
      # name은 step의 이름이 정의되어 있고
      # uses 는 미리 만들어진 action을 이용하는 것이고
      # run 은 직접 인스턴스에 커맨드를 실행하는 것입니다.
      # 첫번째 스텝은 action입니다
      # Github repository의 소스를 가져오는 action입니다.
      - name: Checkout source code
        uses: actions/checkout@v4
      
      # 두번째 step은 인스턴스에 Flutter SDK를 설치하는 action 입니다.
      # with 커맨드를 사용하여 SDK의 상세 버전을 설정할 수 있습니다.
      - name: Install Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.3.2'
      
      # 세번째 step은 해당 레포지토리가 사용하는 패키지를
      #  import하는 단계입니다. 직접 인스턴스에 커맨드를 입력합니다.
      - name: Import Flutter Package
        run: |
          flutter pub get
      # 네번째 step은 작성된 코드를 test하는 단계입니다.
      
      # 다섯번째 step은 작성된 코드를 build 하는 단계입니다.
      # 빌드 후 빌드 된 파일을 프로젝트 루트로 옮기겠습니다.
      # 옮기는 이유 : .gitignore에 build 폴더가 정의되어 있어
      # 추후 사용 불가. 따로 커밋을 하지 않는 이상 
      # 여기서 변경된 사항은 프로젝트에 영향을 주지 않습니다.
      # 이미 web이라는 폴더가 존재하여 web_deploy으로 이름을 변경합니다.
      - name: Build Flutter web
        run: |
          flutter build linux --release --target=lib/server/main.dart
          mv ./build/server .

      - name: create api key file
        run: |
          touch "${{ secrets.API_KEY_PATH }}"
          echo "${{ secrets.GOOGLE_API_KEY }}" >> "${{ secrets.API_KEY_PATH }}"
          touch "${{ secrets.ENV_PATH }}"
          echo "${{ secrets.GSHEET_API_KEY }}" >> "${{ secrets.ENV_PATH }}"
      
      - name: 📦 Zip project files
        run: zip -r ./$GITHUB_SHA.zip

      - name: 🌎 Access to AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_ACCESS_KEY }}
          aws-region: ap-northeast-2a  .

      - name: 🚛 Upload to S3
        run: aws s3 cp --region ap-northeast-2a ./$GITHUB_SHA.zip s3://${{ secrets.S3_BUCKET_NAME }}/${{ env.S3_BUCKET_DIR_NAME }}/$GITHUB_SHA.zip

      - name: 🚀 Deploy to EC2 with CodeDeploy
        run: aws deploy create-deployment
                --application-name hero
                --deployment-config-name CodeDeployDefault.AllAtOnce
                --deployment-group-name deploy-user
                --s3-location bucket=${{ secrets.S3_BUCKET_NAME }},bundleType=zip,key=${{ env.S3_BUCKET_DIR_NAME }}/$GITHUB_SHA.zip
